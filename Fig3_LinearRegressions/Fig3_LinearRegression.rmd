```{r}
library(dplyr)
library(tidyr)
library(lme4)
library(tidyverse)
library(ggpubr)
library(ggtext)
```
Load the soil data
```{r}
soil_lab = read.csv(file.path("../InputData", "soil_lab.csv"), check.names=F)
soil_lab_reduced = soil_lab[, c("Experimental_Year", "Block", "Tillage", "Fertilization", "OM[%]")]
soil_lab_reduced <- soil_lab_reduced %>% dplyr::rename(Year = Experimental_Year)
soil_lab_reduced <- soil_lab_reduced %>%
  mutate(Block = case_when(
    Year == 2019 & Block == "A1" ~ "1",
    Year == 2019 & Block == "A3" ~ "2",
    Year == 2019 & Block == "B1" ~ "3",
    Year == 2019 & Block == "B3" ~ "4",
    TRUE ~ Block 
  ))

soil_lab_reduced <- soil_lab_reduced %>%
  mutate(Block = case_when(
    Block == "A2" ~ "1",
    Block == "A3" ~ "2",
    Block == "B1" ~ "3",
    Block == "B2" ~ "4",
    TRUE ~ Block
  ))

soil_lab_reduced <- soil_lab_reduced %>%
  mutate(Tillage = recode(Tillage, "Plough" = "MP", "Cultivator" = "CT")) %>%
  mutate(Fertilization = recode(Fertilization, "extensive" = "Ext", "intensive" = "Int")) %>% 
  dplyr::rename("OM" = "OM[%]")
```

Load the 16S data
```{r}
metadata=read.csv(file.path("../InputData", "metadata1.csv"))%>%na.omit()
#Load the metadata
```

Create the Sequencer metadata based on the sample name
```{r}
metadata$sequencer=metadata$Year
metadata$sequencer[metadata$sequencer==2019]="miseq"
metadata$sequencer[metadata$sequencer!="miseq"]="novaseq"
metadata$ID=metadata$Sample
```

Read the differential abundances 
```{r,  results="hide"}
ASVtaxonomy=read.csv(file.path("../InputData", "16SMLERarefied_table.csv"),row.names = "X") %>%
  t() %>%
  as.data.frame() %>%
  rownames_to_column(var="ASV")

all_mixed_models_diff=read.csv(file.path("../InputData", "ALL_LLM_testing_with_taxonomy.csv"))

bac_rer_number=unique(colSums( ASVtaxonomy[,-1]))
```
Calculate cumulative relative abundance for CT positive responders in 
root-associated soil
```{r}
all_mixed_models_diff_CT_RAS=filter(all_mixed_models_diff, Treatment=="Tillage"&
                                      Soil_Type=="RAS"&
                                      stat<0)

ASVtaxonomy_CT_RAS=filter(ASVtaxonomy, ASV%in%c(all_mixed_models_diff_CT_RAS$ASV))%>%
  select(unique(metadata$Sample))

ASVtaxonomy_CT_RAS2=data.frame(sum=apply(ASVtaxonomy_CT_RAS, 2,function(x) sum(x))) %>%
  rownames_to_column(var="Sample") %>%
    full_join(metadata) %>%

  select(Fertilization=Int, everything()) %>%
  filter(Soil_Type=="RAS")

ASVtaxonomy_CT_RAS2$Block=as.character(ASVtaxonomy_CT_RAS2$Block)

RAS_CT_data16S <- full_join(soil_lab_reduced, ASVtaxonomy_CT_RAS2, 
                         by = c("Year", "Tillage", "Fertilization", "Block"))
```

Calculate cumulative relative abundance for MP positive responders in 
root-associated soil
```{r}
all_mixed_models_diff_MP_RAS=filter(all_mixed_models_diff, Treatment=="Tillage"&
                                      Soil_Type=="RAS"&
                                      stat>0)

ASVtaxonomy_MP_RAS=filter(ASVtaxonomy, ASV%in%c(all_mixed_models_diff_MP_RAS$ASV))%>%
  select(unique(metadata$Sample))

ASVtaxonomy_MP_RAS2=data.frame(sum=apply(ASVtaxonomy_MP_RAS, 2,function(x) sum(x))) %>%
  rownames_to_column(var="Sample") %>%
    full_join(metadata) %>%

  select(Fertilization=Int, everything()) %>%
  filter(Soil_Type=="RAS")

ASVtaxonomy_MP_RAS2$Block=as.character(ASVtaxonomy_MP_RAS2$Block)

RAS_MP_data16S <- full_join(soil_lab_reduced, ASVtaxonomy_MP_RAS2, 
                         by = c("Year", "Tillage", "Fertilization", "Block"))
```
Calculate cumulative relative abundance for CT positive responders in 
rhizosphere
```{r}
all_mixed_models_diff_CT_RH=filter(all_mixed_models_diff, Treatment=="Tillage"&
                                      Soil_Type=="RH"&
                                      stat<0)

ASVtaxonomy_CT_RH=filter(ASVtaxonomy, ASV%in%c(all_mixed_models_diff_CT_RH$ASV))%>%
  select(unique(metadata$Sample))

ASVtaxonomy_CT_RH2=data.frame(sum=apply(ASVtaxonomy_CT_RH, 2,function(x) sum(x))) %>%
  rownames_to_column(var="Sample") %>%
    full_join(metadata) %>%

  select(Fertilization=Int, everything()) %>%
  filter(Soil_Type=="RH")

ASVtaxonomy_CT_RH2$Block=as.character(ASVtaxonomy_CT_RH2$Block)

RH_CT_data16S <- full_join(soil_lab_reduced, ASVtaxonomy_CT_RH2, 
                         by = c("Year", "Tillage", "Fertilization", "Block"))
```

Calculate cumulative relative abundance for MP positive responders in 
root-associated soil
```{r}
all_mixed_models_diff_MP_RH=filter(all_mixed_models_diff, Treatment=="Tillage"&
                                      Soil_Type=="RH"&
                                      stat>0)

ASVtaxonomy_MP_RH=filter(ASVtaxonomy, ASV%in%c(all_mixed_models_diff_MP_RH$ASV))%>%
  select(unique(metadata$Sample))

ASVtaxonomy_MP_RH2=data.frame(sum=apply(ASVtaxonomy_MP_RH, 2,function(x) sum(x))) %>%
  rownames_to_column(var="Sample") %>%
    full_join(metadata) %>%

  select(Fertilization=Int, everything()) %>%
  filter(Soil_Type=="RH")

ASVtaxonomy_MP_RH2$Block=as.character(ASVtaxonomy_MP_RH2$Block)

RH_MP_data16S <- full_join(soil_lab_reduced, ASVtaxonomy_MP_RH2, 
                         by = c("Year", "Tillage", "Fertilization", "Block"))
```


Calculate cumulative relative abundance for CT positive responders in 
bulk soil
```{r}
memodel <- lme4::lmer(scale(OM)~scale(sum)  + (1|Year), data = RAS_CT_data16S)
#Apply Bootstrap for inferring p-values and 95% CI
boot.out = bootMer(memodel, fixef, seed=11122022, nsim=10000, parallel = "multicore", ncpus = 25) 
print("Boot  finished")
  
CI.lower = apply(boot.out$t, 2, function(x) as.numeric(quantile(x, probs=.025, na.rm=TRUE)))
CI.upper = apply(boot.out$t, 2, function(x) as.numeric(quantile(x, probs=.975, na.rm=TRUE)))
results_df = as.data.frame(summary(boot.out))
p = rbind(
    (1-apply(boot.out$t<0, 2, mean))*2,
    (1-apply(boot.out$t>0, 2, mean))*2)
pvalues=data.frame(pval= apply(p, 2, min))
results_Bac_OM_CT=cbind(results_df, pvalues, lower=CI.lower, upper=CI.upper)

plot_results_Bac_OM_cor=ggplot(RAS_CT_data16S, 
  aes(x=100*sum/bac_rer_number,y=OM, fill=as.factor(Year))) +
  geom_point(shape=21) +
  geom_smooth(method = "lm", alpha=0.5) +
  ylab("SOM[%]") +
  xlab("Cumulative RA% (BS CT-responders) ") +
  theme_bw() +
  scale_fill_brewer(palette = "Set1", name="") +
  theme(plot.title=element_text(size=30,colour="black")) + 
  theme(plot.title=element_markdown()) +
  theme(strip.background=element_rect(fill="white",colour="black")) +
  theme(strip.text=element_text(colour="black", size=25)) +
  
  theme(axis.text.y=element_text(size=30,colour="black")) +
  theme(axis.text.x=element_text(size=30,colour="black")) +
  theme(axis.title.x=element_text(size=35,colour="black")) +
  
  theme(legend.text=element_text(size=35,colour="black")) + 
  theme(legend.title=element_text(size=35,colour="black")) + 
  theme(legend.position="right",axis.title.y=element_text(size=35,colour="black")) + 
  theme(legend.key.size=unit(2,"cm")) +
  
  ggtitle(paste0("β1 = ",round(results_Bac_OM_CT[2,5],2),
          " [",round(results_Bac_OM_CT[2,7],2),
          ", ",round(results_Bac_OM_CT[2,8],2),
                    "], *p* < 0.0001"))
  
#Since p was zero through bootstraps, it was placed as less
# than one divided by the number of bootstraps (10000)
```

Calculate cumulative relative abundance for CT positive responders in 
the rhizosphere
```{r}
memodel <- lme4::lmer(scale(OM)~scale(sum)  + (1|Year), data = RH_CT_data16S)
#Apply Bootstrap for inferring p-values and 95% CI
boot.out = bootMer(memodel, fixef, seed=11122022, nsim=10000, parallel = "multicore", ncpus = 25) 
print("Boot  finished")
  
CI.lower = apply(boot.out$t, 2, function(x) as.numeric(quantile(x, probs=.025, na.rm=TRUE)))
CI.upper = apply(boot.out$t, 2, function(x) as.numeric(quantile(x, probs=.975, na.rm=TRUE)))
results_df = as.data.frame(summary(boot.out))
p = rbind(
    (1-apply(boot.out$t<0, 2, mean))*2,
    (1-apply(boot.out$t>0, 2, mean))*2)
pvalues=data.frame(pval= apply(p, 2, min))
results_Bac_OM_CT=cbind(results_df, pvalues, lower=CI.lower, upper=CI.upper)

plot_results_Bac_OM_cor2=ggplot(RH_CT_data16S, 
  aes(x=100*sum/bac_rer_number,y=OM, fill=as.factor(Year))) +
  geom_point(shape=21) +
  geom_smooth(method = "lm", alpha=0.5) +
  ylab("SOM[%]") +
  xlab("Cumulative RA% (RH CT-responders) ") +
  theme_bw() +
  scale_fill_brewer(palette = "Set1", name="") +
  theme(plot.title=element_text(size=30,colour="black")) +
  theme(plot.title=element_markdown()) + 

  theme(axis.text.y=element_text(size=30,colour="black")) +
  theme(axis.text.x=element_text(size=30,colour="black")) +
  theme(axis.title.x=element_text(size=35,colour="black")) +
  
  theme(strip.background=element_rect(fill="white",colour="black")) +
  theme(strip.text=element_text(size=25,colour="black")) +
  
  theme(legend.text=element_text(size=35,colour="black")) + 
  theme(legend.title=element_text(size=35,colour="black")) + 
  theme(legend.position="right",axis.title.y=element_text(size=35,colour="black")) + 
  theme(legend.key.size=unit(2,"cm")) +
  
  ggtitle(paste0("β1 = ",round(results_Bac_OM_CT[2,5],2),
          " [",round(results_Bac_OM_CT[2,7],2),
          ", ",round(results_Bac_OM_CT[2,8],2),
                    "], *p* < 0.0001")) 

#Since p was zero through bootstraps, it was placed as less
# than one divided by the number of bootstraps (10000)
```

Calculate cumulative relative abundance for MP positive responders in 
the bulk soil 
```{r}
memodel <- lme4::lmer(scale(OM)~scale(sum)  + (1|Year), data = RAS_MP_data16S)
#Apply Bootstrap for inferring p-values and 95% CI
boot.out = bootMer(memodel, fixef, seed=11122022, nsim=10000, parallel = "multicore", ncpus = 25) 
print("Boot  finished")
  
CI.lower = apply(boot.out$t, 2, function(x) as.numeric(quantile(x, probs=.025, na.rm=TRUE)))
CI.upper = apply(boot.out$t, 2, function(x) as.numeric(quantile(x, probs=.975, na.rm=TRUE)))
results_df = as.data.frame(summary(boot.out))
p = rbind(
    (1-apply(boot.out$t<0, 2, mean))*2,
    (1-apply(boot.out$t>0, 2, mean))*2)
pvalues=data.frame(pval= apply(p, 2, min))
results_Bac_OM_MP=cbind(results_df, pvalues, lower=CI.lower, upper=CI.upper)

plot_results_Bac_OM_cor_MP=ggplot(RAS_MP_data16S, 
  aes(x=100*sum/bac_rer_number,y=OM, fill=as.factor(Year))) +
  geom_point(shape=21) +
  geom_smooth(method = "lm", alpha=0.5) +
  ylab("SOM[%]") +
  xlab("Cumulative RA% (BS MP-responders) ") +
  theme_bw() +
  scale_fill_brewer(palette = "Set1", name="") +
  theme(plot.title=element_text(size=30,colour="black")) +
  theme(plot.title = element_markdown()) +   
  theme(strip.background=element_rect(fill="white",colour="black")) +
  theme(strip.text=element_text(size=25,colour="black")) +

  theme(axis.text.y=element_text(size=30,colour="black")) +
  theme(axis.text.x=element_text(size=30,colour="black")) +
  theme(axis.title.x=element_text(size=35,colour="black")) +
  
  theme(legend.text=element_text(size=35,colour="black")) + 
  theme(legend.title=element_text(size=35,colour="black")) + 
  theme(legend.position="right",axis.title.y=element_text(size=35,colour="black")) + 
  theme(legend.key.size=unit(2,"cm")) +
  
  ggtitle(paste0("β1 = ",round(results_Bac_OM_MP[2,5],2),
          " [",round(results_Bac_OM_MP[2,7],2),
          ", ",round(results_Bac_OM_MP[2,8],2),
                    "], *p* < 0.0001")) 

#Since p was zero through bootstraps, it was placed as less
# than one divided by the number of bootstraps (10000)
```

Calculate cumulative relative abundance for MP positive responders in 
the rhizosphere
```{r}
memodel <- lme4::lmer(scale(OM)~scale(sum)  + (1|Year), data = RH_MP_data16S)
#Apply Bootstrap for inferring p-values and 95% CI
boot.out = bootMer(memodel, fixef, seed=11122022, nsim=10000, parallel = "multicore", ncpus = 25) 
print("Boot  finished")
  
CI.lower = apply(boot.out$t, 2, function(x) as.numeric(quantile(x, probs=.025, na.rm=TRUE)))
CI.upper = apply(boot.out$t, 2, function(x) as.numeric(quantile(x, probs=.975, na.rm=TRUE)))
results_df = as.data.frame(summary(boot.out))
p = rbind(
    (1-apply(boot.out$t<0, 2, mean))*2,
    (1-apply(boot.out$t>0, 2, mean))*2)
pvalues=data.frame(pval= apply(p, 2, min))
results_Bac_OM_MP=cbind(results_df, pvalues, lower=CI.lower, upper=CI.upper)

plot_results_Bac_OM_cor_MP2=ggplot(RH_MP_data16S, 
  aes(x=100*sum/bac_rer_number,y=OM, fill=as.factor(Year))) +
  geom_point(shape=21) +
  geom_smooth(method = "lm", alpha=0.5) +
  ylab("SOM[%]") +
  xlab("Cumulative RA% (RH MP-responders) ") +
  theme_bw() +
  scale_fill_brewer(palette = "Set1", name="") +
  theme(plot.title=element_text(size=30,colour="black")) +
  theme(plot.title=element_markdown()) +
  theme(strip.background=element_rect(fill="white", colour="black")) +
  theme(strip.text=element_text(colour="black", size=25)) +
    
  theme(axis.text.y=element_text(size=30,colour="black")) +
  theme(axis.text.x=element_text(size=30,colour="black")) +
  theme(axis.title.x=element_text(size=35,colour="black")) +
  
  theme(legend.text=element_text(size=35,colour="black")) + 
  theme(legend.title=element_text(size=35,colour="black")) + 
  theme(legend.position="right",axis.title.y=element_text(size=35,colour="black")) + 
  theme(legend.key.size=unit(2,"cm")) +
  
  ggtitle(paste0("β1 = ",round(results_Bac_OM_MP[2,5],2),
          " [",round(results_Bac_OM_MP[2,7],2),
          ", ",round(results_Bac_OM_MP[2,8],2),
          "], *p* < 0.0001")) 
  
#Since p was zero through bootstraps, it was placed as less
# than one divided by the number of bootstraps (10000)
```

Combine all plots together
```{r}
plots= ggarrange(
          plot_results_Bac_OM_cor,
          plot_results_Bac_OM_cor2,
          plot_results_Bac_OM_cor_MP,
          plot_results_Bac_OM_cor_MP2, 
          ncol=2,
          nrow=2,      
          common.legend=T)


```
```{r}
png(filename = "Fig3_LinearRegression.png", height = 6000,
    width = 7000, res=350)
print(plots)
dev.off()
```

```{r}
print("The end!")
```